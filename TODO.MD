# План улучшения MCP инструментов (Inspired by line_edit)

## Общие принципы реализации
- **TDD подход**: На каждый чих — тест (граничные кейсы, ошибки, успех).
- **Валидация**: Каждая правка должна завершаться проверкой целостности файла.
- **Обратная совместимость**: Старые способы вызова инструментов должны продолжать работать.

## 1. EditFileTool: Надежность и контекст
- [ ] **Контроль содержимого (`expectedContent`)**
    - Добавить параметр `expectedContent` для операций по номерам строк.
    - Реализовать валидацию: если текущее содержимое строк в файле не совпадает с присланным, транзакция отменяется.
    - **Тесты**: Несовпадение контента, частичное совпадение, пустой файл, разные переносы строк.
- [ ] **Контекстная адресация (`contextStartPattern`)**
    - Добавить возможность поиска "якоря" (регулярного выражения).
    - Позволить указывать `startLine` относительно найденного якоря.
    - **Тесты**: Паттерн не найден, найдено несколько паттернов, паттерн на первой/последней строке.
- [ ] **Автоматический отступ (Auto-indentation)**
    - При вставке новых строк анализировать отступ предыдущей строки и автоматически применять его к новым данным.
    - **Тесты**: Табы vs Пробелы, пустая предыдущая строка, вставка в начало файла.

## 2. EditFileTool: Расширение операций
- [ ] **Типизация операций**
    - Внедрить параметр `operation`: `replace`, `delete`, `insert_before`, `insert_after`.
    - **Тесты**: Удаление последней строки, вставка перед первой строкой, вставка в середину.
- [ ] **Пакетное редактирование (Batching)**
    - Позволить принимать массив операций за один вызов.
    - Реализовать внутренний пересчет смещений строк.
    - **Тесты**: Множественные вставки, удаление и вставка в одном батче, конфликтные пересекающиеся диапазоны.

## 3. ReadFileTool: Умное чтение
- [ ] **Чтение вокруг контекста**
    - Добавить параметр `contextRange`.
    - **Тесты**: Выход за границы файла (сверху/снизу), чтение всего файла через паттерн.

## 4. Общие улучшения
- [ ] **Атомарность операций**
    - Гарантировать откат при любой ошибке внутри батча.
    - **Тесты**: Ошибка на 5-й операции из 10 (проверка, что файл не изменился).